<!DOCTYPE html>
<html lang="en">
<head>
    <title>FDA Recalls</title>

    <meta charset="UTF-8">

    <link href="css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link rel="stylesheet" href="css/font-awesome.min.css">

    <style type="text/css">

      body {
        padding-top: 60px;
      }

      .tooltip-inner{
        text-align: left !important;
      }

      path.arc {
        cursor: move;
        fill: #fff;
      }

      .node {
        font-size: 10px;
        cursor: pointer;
      }

      .node:hover {
        fill: #1f77b4;
      }

      .link {
        fill: none;
        stroke: #999;
        stroke-opacity: .4;
        pointer-events: none;
      }

      .group text {
        font: 11px sans-serif;
        stroke: #000;
      }

      .link.source, .link.target {
        stroke-opacity: 1;
        stroke-width: 2px;
      }

      .node.target {
        fill: #d62728 !important;
        /*color: #999;*/
      }

      .node.source {
        fill: #F57800 !important;
        /*color: #999;*/
      }

      .link.source {
        /*color: #999;*/
        stroke: #d62728;
      }

      .node.source {
        /*fill: #000;*/
        color: #999;
      }

      .link.target {
        stroke: #F57800;
      }


    </style>
</head>
<body>

<script type="text/javascript" src="js/d3.min.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/bootstrap-tooltip.js"></script>
<script type="text/javascript" src="packages.js"></script>



<div class="container">
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
 
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
 
          <a class="brand" href="#">FDA Recalls</a>
     
          <div class="nav-collapse collapse">

            <ul class="nav">
              <li class="active">
                <a href="">2012</a>
              </li>
            </ul>
                <ul class="nav pull-right">
                    <li ><a id='about' href="#" data-toggle="modal" data-target="#myModal"><i class="icon-hand-right"></i> About</a></li>
                    <li ><a id='loading' href="#" data-toggle="modal" data-target="#myModal"><i class="icon-spinner icon-spin"></i> loading data ...</a></li>
                </ul>
          </div>
        </div>
      </div>
    </div>
    
    <div id="main-container">
    </div>
</div>
<script type="text/javascript">
  var monthNumberFormat = d3.time.format("%m");
  var monthNameFormat = d3.time.format("%B");

  var w = 1200,
      h = 1200,
      rx = w / 2,
      ry = h / 2,
      m0,
      rotate = 0
      pi = Math.PI;

  var selected_node;

  var splines = [];

  var cluster = d3.layout.cluster()
      .size([360, ry - 180])
      .sort(function(a, b) { return d3.ascending(a.key, b.key); });

  var bundle = d3.layout.bundle();

  var line = d3.svg.line.radial()
      .interpolate("bundle")
      .tension(.85)
      .radius(function(d) { return d.y; })
      .angle(function(d) { return d.x / 180 * Math.PI; });

  // Chrome 15 bug: <http://code.google.com/p/chromium/issues/detail?id=98951>
  var div = d3.select("#main-container")
    .style("width", w + "px")
    .style("height", w + "px")
    .style("position", "absolute");

  var svg = div.append("svg:svg")
    .attr("width", w)
    .attr("height", w)
    .append("svg:g")
    .attr("transform", "translate(" + rx + "," + ry + ")");

  svg.append("svg:path")
      .attr("class", "arc")
      .attr("d", d3.svg.arc().outerRadius(ry - 180).innerRadius(0).startAngle(0).endAngle(2 * Math.PI))
      .on("mousedown", mousedown);

  d3.json("data/recalls.json", function(classes) {
    var nodes = cluster.nodes(packages.root(classes)),
        links = packages.imports(nodes),
        splines = bundle(links);

    var path = svg.selectAll("path.link")
      .data(links)
      .enter().append("svg:path")
      .attr("class", function(d) { return "link source-" + d.source.key + " target-" + d.target.key; })
      .attr("d", function(d, i) { return line(splines[i]); })
      .attr("stroke-width", function(d, i) { return 2*d.score; });

    var groupData = svg.selectAll("g.group")
      .data(nodes.filter(function(d) { return d.key != null && (d.key == '01' || d.key == '02' || d.key == '03' || d.key == '04')}))
      .enter().append("group")
      .attr("class", "group");
      
    var groupArc = d3.svg.arc()
    .innerRadius(ry - 177)
    .outerRadius(ry - 157)
    .startAngle(function(d) { return (findStartAngle(d.__data__.children)-2) * pi / 180;})
    .endAngle(function(d) { return (findEndAngle(d.__data__.children)+2) * pi / 180});
      
    svg.selectAll("g.arc")
      .data(groupData[0])
      .enter().append("svg:path")
      .attr("d", groupArc)
      .attr("class", "groupArc")
      .style("fill", "#1f77b4")
      .style("fill-opacity", 0.5);

    svg.selectAll("g.node")
      .data(nodes.filter(function(n) { 
        return !n.children; 
      }))
      .enter().append("svg:g")
      .attr("class", "node")
      .attr("id", function(d) { return "node-" + d.key; })
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
      .append("svg:text")
        .attr("id", function(d) { return "text-" + d.key; })
        .attr("dx", function(d) { return d.x < 180 ? 25 : -25; })
        .attr("dy", ".31em")
        .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
        .attr("transform", function(d) { return d.x < 180 ? null : "rotate(180)"; })
        .attr("rel","tooltip")
        .text(function(d) { 
            $("#"+this.id).tooltip({"html": 'true',
              "placement":"right", 
              "title": d.date+"<br><b>Reason</b>: "+d.reason+"<br><b>Product</b>: "+d.product_description
            })
            return d.company 
        })
        .on("mouseover", mouseover)
        .on("mouseout", mouseout)
        .on("click", mouseclicked)
     
    


    d3.select("input[type=range]").on("change", function() {
      line.tension(this.value / 100);
      path.attr("d", function(d, i) { return line(splines[i]); });
    });

    groupData.append("svg:text")
      .attr("x", 6)
      .attr("dy", 15)
      .filter(function(d) { console.log(d.name); return true;})
      .append("svg:textPath")
      .text(function(d) { return 'd.name'; 
    });
  });

  d3.select(window)
      .on("mousemove", mousemove)
      .on("mouseup", mouseup);

  function mouse(e) {
    return [e.pageX - rx, e.pageY - ry];
  }

  function mousedown() {
    m0 = mouse(d3.event);
    d3.event.preventDefault();
  }

  function mousemove() {
    if (m0) {
      var m1 = mouse(d3.event),
          dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;
      div.style("-webkit-transform", "translate3d(0," + (ry - rx) + "px,0)rotate3d(0,0,0," + dm + "deg)translate3d(0," + (rx - ry) + "px,0)");
    }
  }

  function mouseup() {
    if (m0) {
      var m1 = mouse(d3.event),
          dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;

      rotate += dm;
      if (rotate > 360) rotate -= 360;
      else if (rotate < 0) rotate += 360;
      m0 = null;

      div.style("-webkit-transform", "rotate3d(0,0,0,0deg)");

      svg.attr("transform", "translate(" + rx + "," + ry + ")rotate(" + rotate + ")")
        .selectAll("g.node text")
          .attr("dx", function(d) { return (d.x + rotate) % 360 < 180 ? 25 : -25; })
          .attr("text-anchor", function(d) { return (d.x + rotate) % 360 < 180 ? "start" : "end"; })
          .attr("transform", function(d) { return (d.x + rotate) % 360 < 180 ? null : "rotate(180)"; });
    }
  }

  function mouseover(d) {
    svg.selectAll("path.link.target-" + d.key)
        .classed("target", true)
        .each(updateNodes("source", true));

    svg.selectAll("path.link.source-" + d.key)
        .classed("source", true)
        .each(updateNodes("target", true));  }

  function mouseout(d) {
    if( d === selected_node) return;
    svg.selectAll("path.link.source-" + d.key)
        .classed("source", false)
        .each(updateNodes("target", false));

    svg.selectAll("path.link.target-" + d.key)
        .classed("target", false)
        .each(updateNodes("source", false));

   // svg.selectAll("path.link.target-" + d.key)
   //    .classed("target", false)
   //    .each(console.log("source"));
  }

  function mouseclicked(d) {
    relatedNodes =[d]
    if(selected_node != d){

        svg.selectAll("path.link.target-" + d.key).each(
            getNodes("source",relatedNodes)
        )

        svg.selectAll("path.link.source-" + d.key).each(
            getNodes("target",relatedNodes)
        )
      
        if(selected_node != null){
          helper = selected_node
          selected_node = d;
          mouseout(helper)
        }
        selected_node = d;
        mouseover(selected_node)
    }else{
      selected_node = null;
      mouseout(d)
    }

    console.log("relatedNodes\t"+relatedNodes)
  }

  function getNodes(name,relatedNodes) {
    return function(d) {
      relatedNodes.push(d[name]);
    };
  }

  function updateNodes(name, value) {
    return function(d) {
      if (value) this.parentNode.appendChild(this);
      svg.select("#node-" + d[name].key).classed(name, value);
    };
  }

  function cross(a, b) {
    return a[0] * b[1] - a[1] * b[0];
  }

  function dot(a, b) {
    return a[0] * b[0] + a[1] * b[1];
  }

  function findStartAngle(children) {
      var min = children[0].x;
      children.forEach(function(d) {
         if (d.x < min)
             min = d.x;
      });
      return min;
  }

  function findEndAngle(children) {
      var max = children[0].x;
      children.forEach(function(d) {
         if (d.x > max)
             max = d.x;
      });
      return max;
  }

  function getMonth(monthString) {
    if(monthString != null){
      date = monthNumberFormat.parse(monthString); 
      if(date != null && monthNameFormat(date) != null){
        return monthNameFormat(date);
      }else return null;
    }else return null;
  } 
  </script>

  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39939591-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">About</h3>
  </div>
  <div class="modal-body">
    <p>This is an attempt to visualize data published by the CMS (Centers for Medicare &amp; Medicaid Services) on <a href="http://www.healthdata.gov/data/dataset/cms-medicare-and-medicaid-ehr-incentive-program-electronic-health-record-products-used">healthdata.gov</a>. It provides information about where and when providers attested for meaningful use EHR incentives, what EHR vendor they used for attestation etc...</p>
    <p>Map and charts are interactive, so slice the data and see what happens.</p>
    <p>The page relies on the super awesome Dimensional Charting Javascript Library <a href="http://nickqizhu.github.io/dc.js/">dc.js</a>.</p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
</body>
</html>
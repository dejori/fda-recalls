<!DOCTYPE html>
<html lang="en">
<head>
    <title>FDA Recalls</title>

    <meta charset="UTF-8">

    <link href="css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link rel="stylesheet" href="css/font-awesome.min.css">

    <style type="text/css">

      body {
        padding-top: 60px;
      }

      .tooltip-inner{
        text-align: left !important;
      }

      path.arc {
        cursor: move;
        fill: none;
      }

      .node {
        font-size: 10px;
        cursor: pointer;
      }

      .node:hover {
        fill: #d62728;
      }

      .link {
        fill: none;
        stroke: #999;
        stroke-opacity: .4;
        pointer-events: none;
      }

      .group text {
        font: 11px sans-serif;
        stroke: #000;
      }

      .link.source, .link.target {
        stroke-opacity: 1;
      }

      .node.target {
        fill: #F57800;
        /*color: #999;*/
      }

      .node.source {
        fill: #F57800;
        /*color: #999;*/
      }

     /* .node.source {
        fill: #000;
        color: #F57800;
      }*/

      .link.type-product {
        /*color: #999;*/
        stroke: #F57800;
      }

      .link.type-product {
        stroke: #F57800;
      }

      .link.type-reason {
        stroke: green;
      }

      .link.type-reason {
        stroke: green;

      }

      .link.type-both {
        stroke: red;
      }

      .link.type-both {
        stroke: red;
      }

      

      


    </style>
</head>
<body>

<script type="text/javascript" src="js/d3.min.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/bootstrap-tooltip.js"></script>
<script type="text/javascript" src="packages.js"></script>



<div class="container">
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
 
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
 
          <a class="brand" href="#">FDA Recalls</a>
     
          <div class="nav-collapse collapse">

            <ul class="nav">
              <li class="active">
                <a href="">2012</a>
              </li>
            </ul>
                <ul class="nav pull-right">
                    <li ><a id='about' href="#" data-toggle="modal" data-target="#myModal"><i class="icon-hand-right"></i> About</a></li>
                    <li ><a id='loading' href="#" data-toggle="modal" data-target="#myModal"><i class="icon-spinner icon-spin"></i> loading data ...</a></li>
                </ul>
          </div>
        </div>
      </div>
    </div>
    
    <div id="main-container">
    </div>
</div>
<script type="text/javascript">
  var monthNumberFormat = d3.time.format("%m");
  var monthNameFormat = d3.time.format("%B");

  var w = 800,
      h = 800,
      rx = w / 2,
      ry = h / 2,
      m0,
      rotate = 0
      pi = Math.PI;

  var selected_node;

  var splines = [];

  var cluster = d3.layout.cluster()
      .size([360, ry - 180])
      .sort(function(a, b) { return d3.ascending(a.key, b.key); });

  var bundle = d3.layout.bundle();

  var line = d3.svg.line.radial()
      .interpolate("bundle")
      .tension(.85)
      .radius(function(d) { return d.y; })
      .angle(function(d) { return d.x / 180 * Math.PI; });

  // Chrome 15 bug: <http://code.google.com/p/chromium/issues/detail?id=98951>
  var div = d3.select("#main-container")
    .style("width", w + "px")
    .style("height", w + "px")
    .style("position", "absolute");

  var svg = div.append("svg:svg")
    .attr("width", w)
    .attr("height", w)
    .append("svg:g")
    .attr("transform", "translate(" + rx + "," + ry + ")");

  // svg.append("svg:path")
  //     .attr("class", "arc")
  //     .attr("d", d3.svg.arc().outerRadius(ry - 180).innerRadius(0).startAngle(0).endAngle(2 * Math.PI))
  //     .on("mousedown", mousedown);

  d3.json("data/recalls.json", function(classes) {
    var nodes = cluster.nodes(packages.root(classes)),
        links = packages.imports(nodes),
        splines = bundle(links);

    var path = svg.selectAll("path.link")
      .data(links)
      .enter().append("svg:path")
      .attr("id",function(d) { return "source-" + d.source.key + " target-" + d.target.key; })
      .attr("class", function(d) { return "link source-" + d.source.key + " target-" + d.target.key +" type-"+d.type; })
      .attr("d", function(d, i) { return line(splines[i]); })
      .attr("stroke-width", function(d, i) { return 2*d.score; });

    var groupData = svg.selectAll("g.group")
      .data(nodes.filter(function(d) { return $.inArray(d.key, ['01','02','03','04','05','06','07','08','09','10','11','12']) > -1 && d.children }))
      .enter().append("group")
      .attr("class", "group")
      .attr("id",function(d){return d.key});
    
    var groupArc = d3.svg.arc()
      .innerRadius(ry - 177)
      .outerRadius(ry - 157)
      .startAngle(function(d) { return (findStartAngle(d.__data__.children)-2) * pi / 180;})
      .endAngle(function(d) { return (findEndAngle(d.__data__.children)+2) * pi / 180});
      
    svg.selectAll("g.arc")
      .data(groupData[0])
      .enter().append("svg:path")
      .attr("d", groupArc)
      .attr("id",function(d){return "group-"+d.id})
      .attr("class", "groupArc")
      .style("fill", "#1f77b4")
      .style("fill-opacity", 0.5)
      ;

    svg.selectAll("g.node")
      .data(nodes.filter(function(n) { 
        return !n.children; 
      }))
      .enter().append("svg:g")
      .attr("class", "node")
      .attr("id", function(d) { return "node-" + d.key; })
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
      .append("svg:text")
        .attr("id", function(d) { return "text-" + d.key; })
        .attr("dx", function(d) { return d.x < 180 ? 25 : -25; })
        .attr("dy", ".31em")
        .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
        .attr("transform", function(d) { return d.x < 180 ? null : "rotate(180)"; })
        .attr("rel","tooltip")
        .text(function(d) { 
            
            if(d.x <45) placement = "bottom";
            else if(d.x > 45 && d.x < 135) placement = "left";
            else if(d.x > 135 && d.x < 225) placement = "top";
            else if(d.x > 225 && d.x < 315) placement = "right";
            else placement = "bottom";
            $("#"+this.id).tooltip({"html": 'true',
              "placement":placement, 
              "title": "<i>"+d.date+"</i>"+" - "+d.reason+"<br><hr><b>Product</b>: "+d.product_description+"<br><b>Company</b>: "+d.company
            })
            return d.company 
        })
        .on("mouseover", mouseover)
        .on("mouseout", mouseout)
        .on("click", mouseclicked)
     
  


    d3.select("input[type=range]").on("change", function() {
      line.tension(this.value / 100);
      path.attr("d", function(d, i) { return line(splines[i]); });
    });

    svg.selectAll("g.arc")
        .data(groupData[0])
        .enter().append("svg:g")
        .attr("fill", "#fff")
        .append("text")
            .attr("dx", "1em")
            .attr("dy", "1.1em")
            .attr("font-size", "12")
            .append("textPath")
                .attr("xlink:href", function(d){return "#group-"+d.id})
                .text(function(d){return getMonth(d.id)}); 
  });

  d3.select(window)
      .on("mousemove", mousemove)
      .on("mouseup", mouseup);

  // function mouse(e) {
  //   return [e.pageX - rx, e.pageY - ry];
  // }

  // function mousedown() {
  //   m0 = mouse(d3.event);
  //   d3.event.preventDefault();
  // }

  // function mousemove() {
  //   if (m0) {
  //     var m1 = mouse(d3.event),
  //         dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;
  //     div.style("-webkit-transform", "translate3d(0," + (ry - rx) + "px,0)rotate3d(0,0,0," + dm + "deg)translate3d(0," + (rx - ry) + "px,0)");
  //   }
  // }

  // function mouseup() {
  //   if (m0) {
  //     var m1 = mouse(d3.event),
  //         dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;

  //     rotate += dm;
  //     if (rotate > 360) rotate -= 360;
  //     else if (rotate < 0) rotate += 360;
  //     m0 = null;

  //     div.style("-webkit-transform", "rotate3d(0,0,0,0deg)");

  //     svg.attr("transform", "translate(" + rx + "," + ry + ")rotate(" + rotate + ")")
  //       .selectAll("g.node text")
  //         .attr("dx", function(d) { return (d.x + rotate) % 360 < 180 ? 25 : -25; })
  //         .attr("text-anchor", function(d) { return (d.x + rotate) % 360 < 180 ? "start" : "end"; })
  //         .attr("transform", function(d) { return (d.x + rotate) % 360 < 180 ? null : "rotate(180)"; });
  //   }
  // }

  function mouseover(d, sourceNodes, targetNodes) {
        svg.selectAll("path.link.target-" + d.key)
            .classed("target", true)
            .each(updateNodes("source", true));

        svg.selectAll("path.link.source-" + d.key)
            .classed("source", true)
            .each(updateNodes("target", true));  

        if(targetNodes instanceof Array){
            targetNodes.forEach(function(t){
              svg.append("svg:g")
              .attr("id", "text-source-" + d.key + "_target-" + t.key)
              .attr("fill", "#333")
              .append("text")
                  .attr("dx", function(d) { return 250; })
                  .attr("dy", ".31em")
                  .attr("font-size", "14")
                  .attr('background-color','#000')
                  .attr("text-align","center")
                  .append("textPath")
                      .attr("xlink:href", "#"+"source-" + d.key + " target-" + t.key)
                      .text(d.reason);  
            });
        }
        if(sourceNodes instanceof Array){
            sourceNodes.forEach(function(s){
              svg.append("svg:g")
              .attr("id", "text-source-" + s.key + "_target-" + d.key)
              .attr("fill", "#333")
              .append("text")
                  .attr("dy", ".31em")
                  .attr("font-size", "14")
                  .attr('background-color','#000')
                  .attr("text-align","center")
                  .append("textPath")
                      .attr("xlink:href", "#source-" + s.key + " target-" + d.key)
                      .text(d.reason);  
            });
        }
    }

  function mouseout(d,sourceNodes, targetNodes) {
    if( d === selected_node) return;
    svg.selectAll("path.link.source-" + d.key)
      .classed("source", false)
      .each(updateNodes("target", false));

    svg.selectAll("path.link.target-" + d.key)
        .classed("target", false)
        .each(updateNodes("source", false));

    if(sourceNodes instanceof Array){
      sourceNodes.forEach(function(s){
        $("#text-source-" + s.key + "_target-" + d.key).remove();
      });
    }
    if(targetNodes instanceof Array){ 
      targetNodes.forEach(function(t){
        $("#text-source-" + d.key + "_target-" + t.key).remove();
      });
    }
  }

  function mouseclicked(d) {
    clickedNode =d;
    sourceNodes =[]
    targetNodes = []
    if(selected_node != d){
        if(selected_node != null){
          helper = selected_node
          selected_node = d;
          getSourceAndTargetNodes(helper.key,sourceNodes,targetNodes)
          mouseout(helper,sourceNodes,targetNodes)
          
        }

        sourceNodes =[]
        targetNodes = []
        getSourceAndTargetNodes(d.key,sourceNodes,targetNodes)
        selected_node = d;
        mouseover(selected_node,sourceNodes,targetNodes)
    }else{
      getSourceAndTargetNodes(d.key,sourceNodes,targetNodes)
      selected_node = null;
      mouseout(d,sourceNodes,targetNodes)
    }
  }

  function getSourceAndTargetNodes(nodeKey,sourceNodes,targetNodes){
    svg.selectAll("path.link.target-" + nodeKey).each(
        getNodes("source",sourceNodes)
    )

    svg.selectAll("path.link.source-" + nodeKey).each(
        getNodes("target",targetNodes)
    )
  }

  // function getTagCloud
  function getNodes(name,relatedNodes) {
    return function(d) {
      relatedNodes.push(d[name]);
    };
  }

  function updateNodes(name, value) {
    return function(d) {
      if (value) this.parentNode.appendChild(this);
      svg.select("#node-" + d[name].key).classed(name, value);
    };
  }

  function cross(a, b) {
    return a[0] * b[1] - a[1] * b[0];
  }

  function dot(a, b) {
    return a[0] * b[0] + a[1] * b[1];
  }

  function findStartAngle(children) {
    var min = children[0].x;
    children.forEach(function(d) {
       if (d.x < min)
           min = d.x;
    });
    return min;
  }

  function findEndAngle(children) {
    var max = children[0].x;
    children.forEach(function(d) {
       if (d.x > max)
           max = d.x;
    });
    return max;
  }

  function getMonth(monthString) {
    if(monthString != null){
      date = monthNumberFormat.parse(monthString); 
      if(date != null && monthNameFormat(date) != null){
        return monthNameFormat(date);
      }else return null;
    }else return null;
  } 
  </script>

  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39939591-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>

<!-- Modal -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">About</h3>
  </div>
  <div class="modal-body">
    
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
</body>
</html>